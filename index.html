<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneID | Acesso Único</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex items-center justify-center p-4">

    <!-- Overlay carregamento -->
    <div id="loading-overlay" class="absolute inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <i data-lucide="loader-2" class="w-10 h-10 mx-auto mb-3 animate-spin text-indigo-400"></i>
            <p id="loading-message">Carregando portal de autenticação...</p>
        </div>
    </div>

    <!-- Box Principal -->
    <div id="auth-content" class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden hidden">
        <div class="p-8 text-center">
            
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i data-lucide="key-round" class="w-8 h-8"></i>
            </div>

            <h2 class="text-2xl font-bold text-gray-800 mb-2">OneID | Login Único</h2>

            <p class="text-gray-500 mb-6 text-sm">
                Entre para acessar <strong id="app-name-display" class="text-indigo-600">o aplicativo de origem</strong>
            </p>

            <button id="btn-login-google" class="w-full border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition shadow-md">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Continuar com Google
            </button>

        </div>

        <div class="bg-slate-50 p-4 border-t border-gray-100 text-center">
            <p class="text-xs text-gray-400 flex items-center justify-center gap-1">
                <i data-lucide="lock" class="w-3 h-3"></i> O seu acesso é processado com segurança via Firebase.
            </p>
        </div>
    </div>

    <!-- ========================================== -->
    <!--  FIREBASE - MÓDULO COMPLETO (SSO + ANALYTICS) -->
    <!-- ========================================== -->
    <script type="module">

        /* ================================
           IMPORTS DO FIREBASE (CDN OFICIAL)
        ==================================*/
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getAuth, 
            signInWithPopup, 
            GoogleAuthProvider 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        /* =============================
           CONFIG FIREBASE (O SEU)
        ==============================*/
        const firebaseConfig = {
            apiKey: "AIzaSyDZFjQf35AoueYxVAhnm7cl8FogUx1tQ6g",
            authDomain: "meu-login-unico.firebaseapp.com",
            projectId: "meu-login-unico",
            storageBucket: "meu-login-unico.firebasestorage.app",
            messagingSenderId: "855494840908",
            appId: "1:855494840908:web:a322e0d5782f48d2389ae9",
            measurementId: "G-0Y5S5X0GHF"
        };

        /* Inicialização */
        const app = initializeApp(firebaseConfig);

        // Analytics funciona no GitHub Pages
        const analytics = getAnalytics(app);

        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        /* ===========================================
            PARÂMETROS DE REDIRECIONAMENTO DO SSO
        ============================================*/
        const params = new URLSearchParams(window.location.search);
        const redirectTo = params.get("redirect_to");
        const appName   = params.get("app_name") || "o aplicativo de origem";

        document.getElementById("app-name-display").textContent = appName;

        // Exibe conteúdo
        document.getElementById("loading-overlay").classList.add("hidden");
        document.getElementById("auth-content").classList.remove("hidden");

        if (!redirectTo) {
            document.getElementById("auth-content").innerHTML = `
                <div class="p-8 text-center">
                    <i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">URL de Retorno Ausente</h2>
                    <p class="text-gray-500 text-sm">O site que te enviou não informou a URL de retorno.</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        /* ===========================================
            LOGIN COM GOOGLE (POPPER + TOKEN SSO)
        ============================================*/
        document.getElementById("btn-login-google").onclick = () => {

            const btn = document.getElementById("btn-login-google");
            btn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Autenticando...`;

            signInWithPopup(auth, provider)
                .then(result => {
                    const user = result.user;

                    user.getIdToken().then(token => {
                        const finalUrl = `${redirectTo}?token=${token}`;
                        window.location.href = finalUrl;
                    });
                })
                .catch(err => {
                    alert("Erro no login: " + err.message);
                    btn.innerHTML = `
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                        Continuar com Google`;
                });
        };

        lucide.createIcons();

    </script>

</body>
</html>