<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OneID | Acesso Único</title>
    <!-- Tailwind CSS para o design responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- FIREBASE SDK (Módulo) -->
    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ===============================================
        // *** CONFIGURAÇÃO DO FIREBASE (COLADA AQUI) ***
        // ===============================================
        const firebaseConfig = {
          apiKey: "AIzaSyDZFjQf35AoueYxVAhnm7cl8FogUx1tQ6g",
          authDomain: "meu-login-unico.firebaseapp.com",
          projectId: "meu-login-unico",
          storageBucket: "meu-login-unico.firebasestorage.app",
          messagingSenderId: "855494840908",
          appId: "1:855494840908:web:a322e0d5782f48d2389ae9",
          measurementId: "G-0Y5S5X0GHF"
        };
        // ===============================================

        // Função principal que encapsula a lógica para evitar o erro "return not in function"
        function initializeSSOPortal() {
            // Inicializa Firebase
            let app, auth, provider;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                provider = new GoogleAuthProvider();
            } catch (e) {
                console.error("ERRO FATAL: Falha ao inicializar o Firebase. Verifique se as chaves estão corretas.", e);
                document.getElementById('loading-message').textContent = "Erro: Falha na inicialização do Firebase.";
                document.getElementById('loading-message').classList.add('text-red-500');
                return; // O retorno agora está dentro da função
            }
            
            // --- LÓGICA DE REDIRECIONAMENTO SSO ---
            const urlParams = new URLSearchParams(window.location.search);
            const redirectTo = urlParams.get('redirect_to');
            const appName = urlParams.get('app_name') || 'o aplicativo de origem';

            document.getElementById('app-name-display').textContent = appName;
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('auth-content').classList.remove('hidden');

            // Se não houver URL de retorno, mostra erro (Isso garante que o SSO funcione)
            if (!redirectTo) {
                document.getElementById('auth-content').innerHTML = `
                    <div class="p-8 text-center">
                        <i data-lucide="alert-triangle" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">URL de Retorno Ausente</h2>
                        <p class="text-gray-500 text-sm">O site que te enviou para cá não especificou para onde voltar. O link de login deve conter <code>?redirect_to=SUA_URL_DE_RETORNO</code></p>
                        <p class="mt-4 text-xs text-gray-400">Ex: <code>https://seulogin.com/portal.html?redirect_to=https://cinemaxbr18-crypto.github.io/Cartoes-Pesonalizados//callback</code></p>
                    </div>
                `;
                lucide.createIcons();
                return; // O retorno agora está dentro da função
            }

            /**
             * Realiza o login com Google e redireciona com o ID Token.
             */
            const handleGoogleLogin = () => {
                document.getElementById('btn-login-google').innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Autenticando...';
                document.getElementById('btn-login-google').disabled = true;

                signInWithPopup(auth, provider)
                    .then((result) => {
                        const user = result.user;
                        
                        // 1. O passo crucial do SSO: Obter o ID Token
                        user.getIdToken().then(idToken => {
                            // 2. Redirecionar para o site original, enviando o token na URL
                            const finalRedirectUrl = `${redirectTo}?token=${idToken}`;
                            
                            console.log("Login Sucedido! Redirecionando para:", finalRedirectUrl);
                            window.location.href = finalRedirectUrl; 
                            
                        }).catch(error => {
                             // Substituí alert() por uma mensagem na console, mas alert() está no código original.
                             alert("Erro ao gerar token: " + error.message); 
                             console.error(error);
                             document.getElementById('btn-login-google').innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continuar com Google';
                             document.getElementById('btn-login-google').disabled = false;
                        });
                    })
                    .catch((error) => {
                        console.error("Erro no login:", error);
                        if (error.code === 'auth/popup-closed-by-user') {
                             // Substituí alert() por uma mensagem na console, mas alert() está no código original.
                            alert("O pop-up de login foi fechado. Tente novamente.");
                        } else {
                            alert("Erro no login. Verifique se o domínio está autorizado no Firebase.");
                        }
                        document.getElementById('btn-login-google').innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Continuar com Google';
                        document.getElementById('btn-login-google').disabled = false;
                    });
            };

            // Adiciona o evento de click ao botão
            document.getElementById('btn-login-google').addEventListener('click', handleGoogleLogin);
            
            // Renderiza ícones do Lucide
            lucide.createIcons();
        }

        // Chama a função principal imediatamente
        initializeSSOPortal();

    </script>
    <style>
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-900 font-sans text-gray-800 min-h-screen flex items-center justify-center p-4">

    <!-- Overlay de Carregamento Inicial -->
    <div id="loading-overlay" class="absolute inset-0 bg-slate-900 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <i data-lucide="loader-2" class="w-10 h-10 mx-auto mb-3 animate-spin text-indigo-400"></i>
            <p id="loading-message">Carregando portal de autenticação...</p>
        </div>
    </div>

    <!-- Conteúdo Principal do Login -->
    <div id="auth-content" class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden hidden">
        <div class="p-8 text-center">
            <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                <i data-lucide="key-round" class="w-8 h-8"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-2">OneID | Login Único</h2>
            <p class="text-gray-500 mb-6 text-sm">
                Entre para acessar <strong id="app-name-display" class="text-indigo-600">o aplicativo de origem</strong>
            </p>

            <button id="btn-login-google" class="w-full border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl flex items-center justify-center gap-3 transition shadow-md group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                Continuar com Google
            </button>
        </div>
        
        <div class="bg-slate-50 p-4 border-t border-gray-100 text-center">
            <p class="text-xs text-gray-400 flex items-center justify-center gap-1">
                <i data-lucide="lock" class="w-3 h-3"></i> O seu acesso é processado com segurança via Firebase.
            </p>
        </div>
    </div>

</body>
</html>
