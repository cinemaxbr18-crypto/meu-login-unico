<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Consumidor de Teste | Protegido por OneID</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .token-info { word-break: break-all; }
    </style>
    
    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ===============================================
        // *** CONFIGURAÇÃO DO FIREBASE (Projeto: meu-login-unico) ***
        // ===============================================
        const firebaseConfig = {
          apiKey: "AIzaSyDZFjQf35AoueYxVAhnm7cl8FogUx1tQ6g",
          authDomain: "meu-login-unico.firebaseapp.com",
          projectId: "meu-login-unico",
          storageBucket: "meu-login-unico.firebasestorage.app",
          messagingSenderId: "855494840908",
          appId: "1:855494840908:web:a322e0d5782f48d23899ae9",
          measurementId: "G-0Y5S5X0GHF"
        };
        // ===============================================

        let auth;

        // ===============================================
        //  URL DO PORTAL SSO: Aponta para o mesmo repositório
        // ===============================================
        const SSO_LOGIN_URL = "https://cinemaxbr18-crypto.github.io/meu-login-unico/sso_login_portal.html";
        
        // A URL de callback é o endereço deste próprio ficheiro (index.html)
        const CALLBACK_URL = window.location.origin + window.location.pathname;

        function initializeConsumerSite() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const contentDiv = document.getElementById('consumer-content');
            
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
            } catch (e) {
                console.error("Erro ao inicializar Firebase no Site Consumidor.", e);
                return;
            }

            if (token) {
                // --- USUÁRIO VOLTOU COM TOKEN ---
                contentDiv.innerHTML = `
                    <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 mb-6 rounded-lg">
                        <p class="font-bold flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i> Login Único Realizado com Sucesso!</p>
                        <p class="text-sm mt-1">Token recebido e pronto para validação.</p>
                    </div>

                    <div id="token-verification-status" class="p-4 bg-yellow-100 rounded-lg text-yellow-700">
                        <p class="font-bold flex items-center gap-2"><i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Verificando Token...</p>
                    </div>

                    <h3 class="text-xl font-semibold mt-6 mb-2 text-gray-700">Token Recebido</h3>
                    <p class="text-xs text-gray-500 token-info">${token}</p>
                `;
                lucide.createIcons();
                
                // O Firebase usa o token recebido na URL para fazer o login silencioso
                auth.onIdTokenChanged(async (user) => {
                    const statusDiv = document.getElementById('token-verification-status');
                    if (user && user.uid) {
                        // Token validado e sessão criada
                        statusDiv.className = 'p-4 bg-indigo-100 rounded-lg text-indigo-700';
                        statusDiv.innerHTML = `
                            <p class="font-bold flex items-center gap-2"><i data-lucide="lock-open" class="w-5 h-5"></i> Token Validado e Usuário Autenticado.</p>
                            <p class="text-sm mt-1">UID do Usuário: <strong>${user.uid}</strong></p>
                            <p class="text-sm mt-1">Email: <strong>${user.email}</strong></p>
                        `;
                    } else {
                        // Falha na validação ou token expirado
                        statusDiv.className = 'p-4 bg-red-100 rounded-lg text-red-700';
                        statusDiv.innerHTML = `
                            <p class="font-bold flex items-center gap-2"><i data-lucide="x-circle" class="w-5 h-5"></i> Falha na Validação do Token.</p>
                        `;
                    }
                    lucide.createIcons();
                });
                
            } else {
                // --- PÁGINA INICIAL (Não Logado) ---
                contentDiv.innerHTML = `
                    <div class="text-center p-8">
                        <i data-lucide="shield-alert" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Acesso Protegido</h2>
                        <p class="text-gray-600 mb-8">Para visualizar o conteúdo, você deve se autenticar usando nosso sistema de Login Único (OneID).</p>
                        
                        <a id="btn-iniciar-sso" href="#" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl flex items-center justify-center gap-3 transition shadow-lg group">
                            Iniciar Login Único (OneID)
                            <i data-lucide="log-in" class="w-5 h-5 group-hover:translate-x-1 transition"></i>
                        </a>
                    </div>
                `;
                lucide.createIcons();

                // Monta o Link Mágico (inicia o SSO)
                const startSSOLink = document.getElementById('btn-iniciar-sso');
                const finalLink = `${SSO_LOGIN_URL}?redirect_to=${encodeURIComponent(CALLBACK_URL)}&app_name=${encodeURIComponent(document.title)}`;
                startSSOLink.href = finalLink;
                
                console.log("Link Mágico Gerado:", finalLink);
            }
        }
        
        initializeConsumerSite();
        
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-xl overflow-hidden p-6 md:p-10">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-6 border-b pb-3">Meu App Protegido</h1>
        <div id="consumer-content">
            <!-- Conteúdo dinâmico -->
        </div>
        <div class="mt-8 pt-4 border-t border-gray-200">
            <p class="text-sm text-gray-500">
                <span class="font-semibold">Teste de Login Único:</span> Ambos os ficheiros (index.html e sso_login_portal.html) estão no repositório "meu-login-unico".
            </p>
        </div>
    </div>
</body>
</html>
